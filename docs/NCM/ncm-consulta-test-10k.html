<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teste 10k Produtos – Consulta NCM</title>
  <style>
    body{font-family:system-ui;max-width:960px;margin:20px auto;padding:20px;background:#f5f5f5;}
    h1{color:#333;}
    .progress-wrap{background:#e0e0e0;border-radius:8px;height:24px;overflow:hidden;margin:16px 0;}
    .progress-bar{height:100%;background:#1976d2;transition:width .2s;}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:16px 0;}
    .stat{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .stat-label{font-size:0.85em;color:#666;}
    .stat-value{font-size:1.5em;font-weight:700;}
    button{background:#1976d2;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;}
    button:hover{background:#1565c0;}
    button:disabled{background:#9e9e9e;cursor:not-allowed;}
    #log{max-height:200px;overflow-y:auto;background:#fff;padding:12px;border-radius:8px;font-family:monospace;font-size:12px;margin-top:16px;}
    .sample-list{margin-top:16px;}
    .sample-item{padding:6px 10px;margin:4px 0;background:#fff;border-radius:4px;display:flex;justify-content:space-between;font-size:0.9em;}
    .sample-item.ok{border-left:4px solid #4caf50;}
    .sample-item.partial{border-left:4px solid #ff9800;}
    .sample-item.fail{border-left:4px solid #f44336;}
  </style>
</head>
<body>
  <h1>Teste em Lote – Consulta NCM</h1>
  <p>Execute a consulta NCM para produtos diversos. Processamento em lotes para manter o navegador responsivo.</p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <button id="run-btn-500">Executar teste (500 produtos)</button>
    <button id="run-btn">Executar teste (10k produtos)</button>
  </div>
  <div id="progress" style="display:none;">
    <div class="progress-wrap"><div class="progress-bar" id="progress-bar" style="width:0%"></div></div>
    <p id="progress-text">0 / 0</p>
  </div>
  <div id="stats" class="stats" style="display:none;"></div>
  <div id="sample" class="sample-list" style="display:none;"></div>
  <div id="log"></div>

  <script src="Tabela_NCM.js"></script>
  <script src="../../src/support/ncm-motor.js"></script>
  <script src="produtos-teste.js"></script>
  <script>
    var BATCH = 150;
    var SAMPLE_SIZE = 50;

    function runTests(limit) {
      var produtos = (window.PRODUTOS_TESTE && window.PRODUTOS_TESTE.produtos) || [];
      if (!produtos.length) {
        document.getElementById('log').innerHTML = '<p style="color:red;">Carregue produtos-teste.js. Execute: python scripts/ncm/generate_product_tests.py</p>';
        return;
      }
      if (!window.ncmMotor || !window.ncmMotor.isReady()) {
        document.getElementById('log').innerHTML = '<p style="color:red;">Motor NCM não carregado.</p>';
        return;
      }

      var progressDiv = document.getElementById('progress');
      var progressBar = document.getElementById('progress-bar');
      var progressText = document.getElementById('progress-text');
      var statsDiv = document.getElementById('stats');
      var sampleDiv = document.getElementById('sample');

      var runBtns = document.querySelectorAll('#run-btn, #run-btn-500');
      runBtns.forEach(function(b){ b.disabled = true; });
      progressDiv.style.display = 'block';
      statsDiv.style.display = 'grid';

      var total = limit ? Math.min(limit, produtos.length) : produtos.length;
      var produtosSlice = limit ? produtos.slice(0, limit) : produtos;
      var ok = 0, partial = 0, fail = 0, noResult = 0;
      var samples = [];
      var failures = [];
      var idx = 0;

      function processBatch() {
        var end = Math.min(idx + BATCH, total);
        for (var i = idx; i < end; i++) {
          var p = produtosSlice[i];
          var r = window.ncmMotor.sugerirNCM(p.q, { limit: 5 });
          var temResultado = r && r.length > 0;
          var capCorreto = temResultado && r[0].capitulo === p.capEsperado;
          var noCapitulo = temResultado && r.some(function(x){ return x.capitulo === p.capEsperado; });

          if (capCorreto) ok++;
          else if (noCapitulo) partial++;
          else if (!temResultado) { noResult++; if (failures.length < 500) failures.push({q:p.q,esp:p.capEsperado,obt:'-',tipo:'sem'}); }
          else { fail++; if (failures.length < 500) failures.push({q:p.q,esp:p.capEsperado,obt:r[0].capitulo,tipo:'outro'}); }

          if (samples.length < SAMPLE_SIZE && (Math.random() < 0.02 || i < 20 || i > total - 20)) {
            var status = capCorreto ? 'ok' : (noCapitulo ? 'partial' : 'fail');
            samples.push({ q: p.q, esperado: p.capEsperado, top: r && r[0] ? r[0].codigoFormatado + ' (cap.' + r[0].capitulo + ')' : '-', status: status });
          }
        }
        idx = end;
        progressBar.style.width = (idx / total * 100) + '%';
        progressText.textContent = idx + ' / ' + total;

        if (idx < total) {
          requestAnimationFrame(processBatch);
        } else {
          runBtns.forEach(function(b){ b.disabled = false; });
          var rate = total > 0 ? (ok / total * 100).toFixed(2) : 0;
          statsDiv.innerHTML =
            '<div class="stat"><span class="stat-label">Total</span><div class="stat-value">' + total + '</div></div>' +
            '<div class="stat"><span class="stat-label">OK (cap. topo)</span><div class="stat-value" style="color:#4caf50">' + ok + '</div></div>' +
            '<div class="stat"><span class="stat-label">No capítulo</span><div class="stat-value" style="color:#ff9800">' + partial + '</div></div>' +
            '<div class="stat"><span class="stat-label">Sem resultado</span><div class="stat-value" style="color:#9e9e9e">' + noResult + '</div></div>' +
            '<div class="stat"><span class="stat-label">Outro cap.</span><div class="stat-value" style="color:#f44336">' + fail + '</div></div>' +
            '<div class="stat"><span class="stat-label">Taxa acerto</span><div class="stat-value">' + rate + '%</div></div>';

          sampleDiv.style.display = 'block';
          sampleDiv.innerHTML = '<h3>Amostra de resultados</h3>' + samples.slice(0, 30).map(function(s) {
            return '<div class="sample-item ' + s.status + '"><span>' + s.q + '</span><span>' + s.top + ' (esp.' + s.esperado + ')</span></div>';
          }).join('');

          var failSample = failures.slice(0, 15).map(function(f){ return f.q + ' → esp.' + f.esp + ' obt.' + f.obt; }).join('<br>');
          document.getElementById('log').innerHTML = '<p>Concluído. Taxa de acerto: <strong>' + rate + '%</strong></p>' +
            (failures.length > 0 ? '<details><summary>Exemplos de falhas (' + failures.length + ')</summary><p style="font-size:12px;margin-top:8px">' + failSample + '</p></details>' : '');
        }
      }
      requestAnimationFrame(processBatch);
    }

    document.getElementById('run-btn').addEventListener('click', function(){ runTests(); });
    document.getElementById('run-btn-500').addEventListener('click', function(){ runTests(500); });
  </script>
</body>
</html>

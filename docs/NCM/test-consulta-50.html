<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Consulta 200 produtos (nomenclatura desconexa)</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; max-width: 1200px; }
    h1 { font-size: 1.25rem; }
    .meta { color: #666; margin-bottom: 16px; }
    button { padding: 10px 20px; margin: 8px 0; cursor: pointer; }
    pre { background: #f5f5f5; padding: 12px; overflow: auto; white-space: pre-wrap; font-size: 12px; max-height: 60vh; }
    .ok { color: #059669; }
    .err { color: #dc2626; }
    .warn { color: #b45309; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 10px; text-align: left; }
    th { background: #eee; }
    tr:nth-child(even) { background: #fafafa; }
    .src-motor { color: #059669; }
    .src-ia { color: #2563eb; }
    .src-nenhum { color: #dc2626; }
  </style>
</head>
<body>
  <h1>Teste Consulta – 200 produtos (nomenclatura desconexa)</h1>
  <p class="meta">Fluxo: Wikipedia (pt) → Motor → se 0 resultados → IA (embeddings + filtros). Mesmo pipeline da aba Consulta de Produto.</p>
  <button id="run">Executar 200 consultas</button>
  <pre id="log">Clique em "Executar 200 consultas".</pre>
  <div id="table-wrap" style="display: none;">
    <h2>Resumo</h2>
    <table id="tbl">
      <thead>
        <tr><th>#</th><th>Produto</th><th>Status</th><th>Fonte</th><th>1ª NCM</th><th>Cap.</th><th>Qtd</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script src="Tabela_NCM.js"></script>
  <script src="../../src/support/ncm-motor.js"></script>
  <script src="../../src/support/ncm-wikipedia.js"></script>
  <script src="../../src/support/ncm-embeddings.js"></script>
  <script>
    (function () {
      var PRODUTOS = [
        '2UN COCA COLA 350ML LATA PROM+BAT 0,01',
        'ABACATE KG',
        'ABACAXI EM CALDAS PREDILECTA 400G',
        'ACEROLA PCT HR FRUTAS 500G',
        'ACESSORIO CABELO MECHAS MOD 7 PA1604-C',
        'ACETATO WOBBLER CONCURSO CULTURAL BIKE',
        'ACETONA FARMAX 100ML',
        'ACHOC LIQ BETAKIDS 200ML',
        'ARROZ T1 5KG',
        'REF COLA 2L',
        'BOLACH RECHEADA 140G OREO',
        'LEITE INT UHT 1L',
        'OLEO SOJA 900ML',
        'AÇUCAR CRISTAL 1KG',
        'FEIJAO PRETO 1KG',
        'MACARRAO ESPAG 500G',
        'MOLHO TOMATE 340G',
        'SALSICHA VIENA 300G',
        'QUEIJO MUSSARELA FAT 100G',
        'IOG NATURAL 170G',
        'MARGARINA 500G',
        'PÃO FORMA INT 400G',
        'BISCOITO CREAM CRACKER 140G',
        'CAFE TORRADO MOIDO 500G',
        'CHA MATE 1L',
        'SUCO LARANJA 1L',
        'AGUA MINERAL 1,5L',
        'CERVEJA LATA 350ML',
        'VINHO TINTO 750ML',
        'DETERGENTE 500ML',
        'SABONETE LIQ 250ML',
        'SHAMPOO 400ML',
        'PAPEL HIG 12ROL',
        'FRAUD DEL 1L',
        'DESOD AER 150ML',
        'CREME DENTAL 90G',
        'FIO DENTAL 50M',
        'ESCOVA DENTE',
        'PRESERVativo 3UN',
        'ANALGESICO 500MG 20CP',
        'VITAMINA C 1G 30CP',
        'CURATIVO ADESIVO 20UN',
        'ALGODAO HIDR 50G',
        'SERINGA DESC 10ML',
        'FITA CREPE 25MM',
        'PILHA AA 4UN',
        'LAMPADA LED 9W',
        'FITA ADESIVA 48MM',
        'CANETA BIC AZUL',
        'LAPIS 2B',
        'CADERNO 96FL',
        'PAPEL A4 500FL',
        'TESOURA ESCOLAR',
        'COLA BASTAO 40G',
        'TINTA ACRILICA 12COR',
        'PINCEL N12',
        'FITA DUPLA FACE',
        'BORRACHA',
        'APONTADOR',
        'REF LARANJA 2L',
        'SUCO UVA 1L INT',
        'AGUA TONICA 350ML',
        'ENERGETICO 250ML',
        'CERVEJA LONGA 473ML',
        'VINHO BRANCO 750ML',
        'WHISKY 1L',
        'VODKA 998ML',
        'RUM 750ML',
        'REQUEIJAO CREMOSO 200G',
        'CREME LEITE 200G',
        'LEITE COND 395G',
        'IOG FRUTA 170G',
        'MANTEIGA 200G',
        'QUEIJO PRATO 150G',
        'QUEIJO COALHO 400G',
        'PEITO FRANGO KG',
        'CARNE MOIDA KG',
        'LINGUICA TOSCANA 500G',
        'BACON FAT 100G',
        'PRESUNTO DEFUM 150G',
        'MORTADELA 200G',
        'FILE PEIXE 400G',
        'CAMARAO CONG 300G',
        'SARDINHA LATA 125G',
        'ATUM LATA 170G',
        'ARROZ PARBO 5KG',
        'FEIJAO CARIOCA 1KG',
        'LENTILHA 500G',
        'GRAO BICO 500G',
        'MILHO VERDE LATA 170G',
        'ERVILHA LATA 200G',
        'MACARRAO PENNE 500G',
        'MACARRAO PARAFUSO 500G',
        'LASANHA 500G',
        'FARINHA TRIGO 1KG',
        'FARINHA MANDIOCA 500G',
        'AMIDO MILHO 500G',
        'BOLO FORM 400G',
        'MIX BOLO 400G',
        'GELATINA 25G',
        'PUDIM PO 85G',
        'CHOCOLATE AO LEITE 90G',
        'CHOCOLATE BRANCO 80G',
        'BALA CARAMELO 1KG',
        'CHICLETE 14UN',
        'PIRULITO 50UN',
        'BATATA CHIPS 140G',
        'SALGADINHO 80G',
        'AMENDOIM 200G',
        'PIPOCA MIC 100G',
        'BARR CEREAL 30G',
        'MEL 500G',
        'GELEIA MORANGO 250G',
        'KETCHUP 397G',
        'MAIONESE 500G',
        'MOSTARDA 180G',
        'MOLHO SHOYU 150ML',
        'TEMPERO COMPLETO 100G',
        'CALDO CARNE 57G',
        'LEVEDURA 15G',
        'SAL REFIN 1KG',
        'PIMENTA PRETA 30G',
        'OREGANO 15G',
        'AZEITE 500ML',
        'OLEO MILHO 900ML',
        'OLEO GIRASSOL 900ML',
        'ALVEJANTE 2L',
        'DESINFETANTE 2L',
        'SABAO PO 1KG',
        'SABAO LIQ 2L',
        'AMACIANTE 2L',
        'ESPONJA MULTI 3UN',
        'PAPEL TOALHA 2ROL',
        'GUARDANAPO 40X40 100UN',
        'SACO LIXO 30L 20UN',
        'FILME PVC 30CM',
        'PAPEL ALUM 30CM',
        'FOSFORO 10CX',
        'VELA 12UN',
        'REPELENTE 170ML',
        'INSETICIDA 300ML',
        'ADUBO 1KG',
        'TERRA VEGETAL 20L',
        'SEMENTE GRAMA 1KG',
        'CONDIC SHAMPOO 400ML',
        'HIDRATANTE CORPO 400ML',
        'PROTETOR SOLAR 200ML',
        'DESOD ROLL 50ML',
        'GILETE DESC 5UN',
        'ESPUMA BARBEAR 200G',
        'COTONETE 170UN',
        'LENCO UMED 80UN',
        'FRALDA DESC P 24UN',
        'ABSORVENTE 8UN',
        'XAROPE 120ML',
        'ANTIALERGICO 10ML',
        'DIPIRONA 500MG 20CP',
        'OMEPRAZOL 20MG 14CP',
        'LOSARTANA 50MG 30CP',
        'PARACETAMOL 750MG 20CP',
        'IBUPROFENO 600MG 20CP',
        'BANDAGEM 10CM',
        'GAZE ESTERIL 10X10',
        'LUVAS DESC 100UN',
        'MASCAR DESC 50UN',
        'TERMOMETRO DIG',
        'BALANCA DIG 5KG',
        'FITA METRICA 5M',
        'CHAVE FENDA',
        'ALICATE',
        'MARTELO',
        'PARAFUSO 4X30 50UN',
        'PREGO 18X27 1KG',
        'FECHADURA',
        'Dobradica 2UN',
        'TINTA LATEX 18L',
        'PINCEL LATA 4',
        'ROLO PINTURA',
        'MASS CORRIG 1KG',
        'FITA ISOLANTE 19MM',
        'TOMADA 2P+T',
        'INTERRUPTOR',
        'EXTENSAO 5M',
        'ADAPTADOR',
        'CABO ELETRICO 10M',
        'LAMPADA FLUOR 15W',
        'REFLETOR LED 50W',
        'BATERIA 9V',
        'CARREGADOR PILHA',
        'FONE OUVIDO',
        'PEN DRIVE 32GB',
        'CABO USB 1M',
        'MOUSE USB',
        'TECLADO USB'
      ];

      var logEl = document.getElementById('log');
      var tbody = document.getElementById('tbody');
      var tableWrap = document.getElementById('table-wrap');
      var logLines = [];

      function log(s, type) {
        logLines.push(s);
        var cls = type || '';
        if (s.indexOf('OK') !== -1 && s.indexOf('FALHA') === -1) cls = 'ok';
        else if (s.indexOf('FALHA') !== -1 || s.indexOf('0 sugestões') !== -1) cls = 'err';
        else if (s.indexOf('IA') !== -1 || s.indexOf('Wikipedia') !== -1) cls = 'warn';
        logEl.innerHTML = logLines.map(function (x) {
          var c = x.indexOf('OK') !== -1 && x.indexOf('FALHA') === -1 ? 'ok' : (x.indexOf('FALHA') !== -1 ? 'err' : '');
          return '<span class="' + c + '">' + (x || ' ').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
        }).join('\n');
        logEl.scrollTop = logEl.scrollHeight;
      }

      async function runConsulta(produto) {
        var motor = window.ncmMotor;
        var wiki = window.ncmWikipedia;
        var emb = window.ncmEmbeddings;
        var texto = produto;
        if (wiki && typeof wiki.enriquecerComWikipedia === 'function') {
          try {
            var w = await wiki.enriquecerComWikipedia(produto);
            if (w.wikiUsado && w.textoEnriquecido) texto = w.textoEnriquecido;
          } catch (e) {}
        }
        var list = motor && motor.sugerirNCM ? motor.sugerirNCM(texto, { limit: 20, prefer8: true }) : [];
        var fonte = 'motor';
        if (!list || list.length === 0) {
          if (emb && typeof emb.sugerirNCMEmbeddings === 'function') {
            try {
              var iaOpts = {
                limit: 20,
                minSimilarity: 0.28,
                requireTokenOverlap: true,
                chapterHint: motor && motor.getChapterHint ? motor.getChapterHint(texto) : null,
                tokens: motor && motor.getExpandedTokensForProduct ? motor.getExpandedTokensForProduct(texto) : (motor && motor.getTokensForProduct ? motor.getTokensForProduct(texto) : null)
              };
              list = await emb.sugerirNCMEmbeddings(texto, iaOpts) || [];
              fonte = 'ia';
            } catch (e) {}
          }
        }
        var top = list && list[0];
        return {
          produto: produto,
          status: list && list.length > 0 ? 'OK' : 'VAZIO',
          fonte: (list && list.length > 0) ? fonte : 'nenhum',
          ncm: top ? top.codigoFormatado : '',
          cap: top ? (top.capitulo || '') : '',
          qtd: list ? list.length : 0
        };
      }

      function triggerRun() { document.getElementById('run').click(); }
      if (/[?&]run=1/.test(location.search)) setTimeout(triggerRun, 800);

      document.getElementById('run').addEventListener('click', async function () {
        var btn = this;
        btn.disabled = true;
        logLines = [];
        log('=== Teste Consulta 200 produtos (nomenclatura desconexa) ===');
        log('Produtos: ' + PRODUTOS.length);

        if (!window.NCM_TABELA_DATA) {
          log('[FALHA] NCM_TABELA_DATA não carregado.');
          btn.disabled = false;
          return;
        }
        log('[OK] Tabela NCM carregada.');

        if (!window.ncmMotor || !window.ncmMotor.isReady()) {
          log('[FALHA] Motor não pronto.');
          btn.disabled = false;
          return;
        }
        log('[OK] Motor pronto. Wikipedia: ' + (window.ncmWikipedia ? 'sim' : 'não') + ', Embeddings: ' + (window.ncmEmbeddings ? 'sim' : 'não') + '.');
        log('');

        var results = [];
        var i, r;
        for (i = 0; i < PRODUTOS.length; i++) {
          r = await runConsulta(PRODUTOS[i]);
          results.push(r);
          var line = (i + 1) + '/' + PRODUTOS.length + ' ' + r.status + ' [' + r.fonte + '] ' + (r.ncm || '-') + ' | ' + (r.produto.length > 45 ? r.produto.slice(0, 42) + '...' : r.produto);
          log(line);
        }

        var ok = results.filter(function (x) { return x.status === 'OK'; }).length;
        var motorCount = results.filter(function (x) { return x.fonte === 'motor'; }).length;
        var iaCount = results.filter(function (x) { return x.fonte === 'ia'; }).length;
        var vazio = results.filter(function (x) { return x.status === 'VAZIO'; }).length;

        log('');
        log('=== Resumo ===');
        log('Total: ' + PRODUTOS.length + ' | Com sugestão: ' + ok + ' | Motor: ' + motorCount + ' | IA: ' + iaCount + ' | Sem sugestão: ' + vazio);

        tbody.innerHTML = '';
        results.forEach(function (r, idx) {
          var tr = document.createElement('tr');
          var srcCls = r.fonte === 'motor' ? 'src-motor' : (r.fonte === 'ia' ? 'src-ia' : 'src-nenhum');
          tr.innerHTML = '<td>' + (idx + 1) + '</td><td title="' + (r.produto || '').replace(/"/g, '&quot;') + '">' + (r.produto.length > 50 ? r.produto.slice(0, 47) + '...' : r.produto) + '</td><td>' + r.status + '</td><td class="' + srcCls + '">' + r.fonte + '</td><td>' + (r.ncm || '-') + '</td><td>' + (r.cap || '-') + '</td><td>' + r.qtd + '</td>';
          tbody.appendChild(tr);
        });
        tableWrap.style.display = 'block';
        log('=== Fim ===');
        btn.disabled = false;
      });
    })();
  </script>
</body>
</html>
